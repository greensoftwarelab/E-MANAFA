

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>manafa.parsing.batteryStats.BatteryStatsParser &mdash; e-manafa 0.3.5 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> e-manafa
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../README.html">E-MANAFA: Energy Monitor and ANAlyzer For Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">manafa</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">e-manafa</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>manafa.parsing.batteryStats.BatteryStatsParser</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for manafa.parsing.batteryStats.BatteryStatsParser</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; This module contains ENUMs that store state values of batterystats events.</span>

<span class="sd">BatteryStatsConstants contains constants associated with batterystats events and respective meaning.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">json</span>
<span class="c1"># sys.path.append(path.dirname(path.dirname(path.abspath(__file__))))</span>

<span class="kn">from</span> <span class="nn">manafa.parsing.powerProfile.PowerProfile</span> <span class="kn">import</span> <span class="n">PowerProfile</span>
<span class="kn">from</span> <span class="nn">manafa.utils.Utils</span> <span class="kn">import</span> <span class="n">get_resources_dir</span>
<span class="kn">from</span> <span class="nn">manafa.utils.dateUtils</span> <span class="kn">import</span> <span class="n">convertBatStatTimeToTimeStamp</span><span class="p">,</span> <span class="n">batStatResetTimeToTimeStamp</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">manafa.utils.Logger</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">LogSeverity</span>

<span class="n">DEFAULT_JSON_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_resources_dir</span><span class="p">(),</span> <span class="s2">&quot;batteryStats&quot;</span><span class="p">,</span> <span class="s2">&quot;BatteryStatus.json&quot;</span><span class="p">)</span>



<div class="viewcode-block" id="safe_division"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.safe_division">[docs]</a><span class="k">def</span> <span class="nf">safe_division</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;function to safely perform division between numbers to avoid division by 0.</span>
<span class="sd">        Args:</span>
<span class="sd">            a (float): base.</span>
<span class="sd">            a (float): quote.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: the result of the division.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">z</span></div>


<div class="viewcode-block" id="BatteryEvent"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryEvent">[docs]</a><span class="k">class</span> <span class="nc">BatteryEvent</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to store information information parsed from the lines of batterystats history events.</span>

<span class="sd">    This class stores information of one or more lines (when consecutive lines have the same timestamp)</span>
<span class="sd">    of batterystats history events.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        time (float): Stores timestamp of event (s.ms).</span>
<span class="sd">        updates (dict): stores component updates (components referred in power_profile.xml) registered in time timestamp.</span>
<span class="sd">        current (dict): stores instant current being consumed by each component.</span>
<span class="sd">        concurrentUpdates (dict); stores information regarding other updates that are not directly related to energy</span>
<span class="sd">         consumption.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Init Battery event with parsed information.</span>

<span class="sd">        Args:</span>
<span class="sd">           time (float): timestamp of event (s.ms).</span>
<span class="sd">           vals (dict): events registered in batterystats history line(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currents</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concurrentUpdates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tmpwhitelist&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;job&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;sync&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;longwake&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="p">[],</span>
                                  <span class="s2">&quot;proc&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;screenwake&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;pkgactive&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;userfg&quot;</span><span class="p">:</span> <span class="p">[],</span>
                                  <span class="s2">&quot;wake_lock_in&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;alarm&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_events</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;time:</span><span class="si">%f</span><span class="s2"> vals =  </span><span class="si">%s</span><span class="s2"> , concs= </span><span class="si">%s</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrentUpdates</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="BatteryEvent.is_concurrent"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryEvent.is_concurrent">[docs]</a>    <span class="k">def</span> <span class="nf">is_concurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;checks if is a concurrent update (aka event not related to hardware/sensor state change).</span>

<span class="sd">        Args:</span>
<span class="sd">           state (str): timestamp of event (s.ms).</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if successful, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return re.match(r&quot;(\+|\-)?(tmpwhitelist|job|sync|top|longwake|fg|proc)&quot;, state)</span>
        <span class="k">return</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">concurrentUpdates</span></div>

<div class="viewcode-block" id="BatteryEvent.get_current_of_batStatEvent"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryEvent.get_current_of_batStatEvent">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_of_batStatEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;gets total current being consumed by the current state of hardware usage.</span>
<span class="sd">        Args:</span>
<span class="sd">           state (str): timestamp of event (s.ms).</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: total current being consumed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">currs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">currents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">currs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span> <span class="o">/</span> <span class="mi">1000</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">z</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">currs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">currs</span></div>

<div class="viewcode-block" id="BatteryEvent.get_voltage_value"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryEvent.get_voltage_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_voltage_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;gets current voltage value (last value recorded in history lines).</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: total current value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="p">[</span><span class="s2">&quot;volt&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">1000</span> <span class="k">if</span> <span class="s2">&quot;volt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates</span> <span class="k">else</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="BatteryEvent.add_events"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryEvent.add_events">[docs]</a>    <span class="k">def</span> <span class="nf">add_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_events</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a set of events to the current state.</span>
<span class="sd">        Args:</span>
<span class="sd">           new_events (dict): set of events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">new_events</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># print(&quot;-&gt;&quot;+ev + &quot;--&quot;)</span>
            <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">conc_update_state</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_concurrent</span><span class="p">(</span><span class="n">conc_update_state</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">concurrentUpdates</span><span class="p">[</span><span class="n">conc_update_state</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">concurrentUpdates</span><span class="p">[</span><span class="n">conc_update_state</span><span class="p">]</span> <span class="k">if</span>
                                                                 <span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_events</span><span class="p">[</span><span class="n">ev</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">n</span><span class="p">[</span><span class="s2">&quot;val2&quot;</span><span class="p">]</span> <span class="o">!=</span>
                                                                  <span class="n">new_events</span><span class="p">[</span><span class="n">ev</span><span class="p">][</span><span class="s2">&quot;val2&quot;</span><span class="p">])]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">conc_update_state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ev_def</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_concurrent</span><span class="p">(</span><span class="n">ev_def</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">concurrentUpdates</span><span class="p">[</span><span class="n">ev_def</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_events</span><span class="p">[</span><span class="n">ev</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="p">[</span><span class="n">ev_def</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_events</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="BatteryStatsParser"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser">[docs]</a><span class="k">class</span> <span class="nc">BatteryStatsParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that handles parsing of batterystats history events</span>

<span class="sd">    This class parses and batterystats history events from files parsed using parseFile function. It starts by load</span>
<span class="sd">    information contained in the device power profile file and also the current state values known by the profiler,</span>
<span class="sd">    stored in definitions attribute.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        events (:obj:`list` of :obj:`BatteryEvent`): stores BatteryEvents by order of occurence.</span>
<span class="sd">        definitions (dict): stores definitions ok known states support by batterystats and manafa.</span>
<span class="sd">        powerProfile (:obj:`PowerProfile`): stores information parsed from power profile file.</span>
<span class="sd">        android_version (int): Android release version.</span>
<span class="sd">        start_time (int): initial timestamp inferred from first line of batstats history.</span>
<span class="sd">        timezone (str): current device timezone.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">powerProfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="s2">&quot;EST&quot;</span><span class="p">,</span> <span class="n">def_file</span><span class="o">=</span><span class="n">DEFAULT_JSON_PATH</span><span class="p">,</span> <span class="n">android_version</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_definition_file</span><span class="p">(</span><span class="n">def_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">powerProfile</span> <span class="o">=</span> <span class="n">PowerProfile</span><span class="p">(</span><span class="n">powerProfile</span><span class="p">)</span> <span class="k">if</span> <span class="n">powerProfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">android_version</span> <span class="o">=</span> <span class="n">android_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">timezone</span>  <span class="c1"># adb shell  date +&quot;%Z %z&quot;</span>

<div class="viewcode-block" id="BatteryStatsParser.load_definition_file"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.load_definition_file">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_definition_file</span><span class="p">(</span><span class="n">def_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;loads definitions attribute from json file</span>
<span class="sd">        Args:</span>
<span class="sd">            def_file (str): filepath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">def_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dff</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dff</span><span class="p">)</span></div>

<div class="viewcode-block" id="BatteryStatsParser.get_definition_val"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.get_definition_val">[docs]</a>    <span class="k">def</span> <span class="nf">get_definition_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return value of component from key and opt val.</span>
<span class="sd">        Args:</span>
<span class="sd">            key(str): key that identifies component.</span>
<span class="sd">            val(str): optional sub key.</span>
<span class="sd">        Returns:</span>
<span class="sd">            int: value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\+|\-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;monoval&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;trival&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">key</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;numerical&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)][</span><span class="n">val</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BatteryStatsParser.is_trival"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.is_trival">[docs]</a>    <span class="k">def</span> <span class="nf">is_trival</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;check if is a component with more than 2 values associated.</span>
<span class="sd">        Args:</span>
<span class="sd">            key: component key.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: result of check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\+|\-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;trival&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="BatteryStatsParser.parse_states"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.parse_states">[docs]</a>    <span class="k">def</span> <span class="nf">parse_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses states from batstats history line.</span>
<span class="sd">        Args:</span>
<span class="sd">            states: string containing the state updates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: parsed events</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">accumulator</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">latest_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^ &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">states</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">):</span>
            <span class="c1"># print(&quot;-&gt;&quot; +state)</span>
            <span class="k">if</span> <span class="n">accum</span><span class="p">:</span>
                <span class="n">accumulator</span> <span class="o">+=</span> <span class="n">state</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">accum</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">accum</span>
                    <span class="n">accumulator</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">accum</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">accumulator</span> <span class="o">+=</span> <span class="n">state</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_definition_val</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_trival</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                        <span class="c1"># print(&quot;%s - %s -%s&quot; %(key,val.split(&quot;:&quot;)[0],val.split(&quot;:&quot;)[1]))</span>
                        <span class="c1"># return key,val.split(&quot;:&quot;)[0],val.split(&quot;:&quot;)[1]</span>
                        <span class="n">events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;val2&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># print(&quot;%s = %s&quot; %(key,state))</span>
                        <span class="n">events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_definition_val</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="c1"># print(&quot;%s - %s&quot; %(state,st))</span>
                <span class="c1"># print(&quot;val &quot;+str(self.getDefinitionVal(state)))</span>
                <span class="n">events</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="k">return</span> <span class="n">events</span></div>

<div class="viewcode-block" id="BatteryStatsParser.parse_history"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.parse_history">[docs]</a>    <span class="k">def</span> <span class="nf">parse_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse history events from list of lines read from file.</span>

<span class="sd">        Parses history events and stores them in  the respective attribute fields.</span>
<span class="sd">        Args:</span>
<span class="sd">            lines_list(:obj:`list` of :obj:`str`): list of lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^Battery History \([0-9]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="c1"># header, ignore</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^Per-PID Stats&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*([^\s]+) (\(\d+\)) (\d+)(.*)?$&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*([^\s]+) (\(\d+\)) (\d+)(.*)?$&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">convertBatStatTimeToTimeStamp</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timezone</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timezone</span><span class="p">)</span>
                <span class="n">time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
                <span class="c1"># print(time)</span>
                <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_update</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*0 (\(\d+\)) (.*)?$&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*0 (\(\d+\)) (.*)?$&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;RESET:TIME&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">batStatResetTimeToTimeStamp</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;RESET:TIME: &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">timezone</span><span class="p">)</span>
                <span class="c1"># print(epochToDate(self.start_time))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO Handle DcpuStats and DpstStats</span>
                <span class="c1"># print(line)</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Unrecognized patter in line of batstats file&quot;</span><span class="p">,</span> <span class="n">LogSeverity</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span></div>

<div class="viewcode-block" id="BatteryStatsParser.add_update"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.add_update">[docs]</a>    <span class="k">def</span> <span class="nf">add_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">bat_events</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds new event updates to current state.</span>

<span class="sd">        Args:</span>
<span class="sd">            time(int): timestamp of new events.</span>
<span class="sd">            bat_events(:obj:`list` of :obj:`dict`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bt</span> <span class="o">=</span> <span class="n">BatteryEvent</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">bat_events</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">estimate_current_consumption</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">last_added</span><span class="o">.</span><span class="n">time</span> <span class="o">==</span> <span class="n">time</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_events</span><span class="p">(</span><span class="n">bat_events</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO try to replace with shallow copy</span>
                <span class="n">bt</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bt</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>
                <span class="n">bt</span><span class="o">.</span><span class="n">add_events</span><span class="p">(</span><span class="n">bat_events</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">estimate_current_consumption</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span></div>

<div class="viewcode-block" id="BatteryStatsParser.estimate_current_consumption"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.estimate_current_consumption">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_current_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bt_event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;estimates current power being consumed by event.</span>
<span class="sd">        Args:</span>
<span class="sd">            bt_event(str): key of the event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">power</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">powerProfile</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determinate_component_current</span><span class="p">(</span><span class="n">bt_event</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">power</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="c1"># print(&quot;%s %s&quot; %(p , str(st)))</span>
        <span class="n">bt_event</span><span class="o">.</span><span class="n">currents</span> <span class="o">=</span> <span class="n">power</span></div>

<div class="viewcode-block" id="BatteryStatsParser.get_closest_pair"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.get_closest_pair">[docs]</a>    <span class="k">def</span> <span class="nf">get_closest_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns closest events of a given timestamp time.</span>
<span class="sd">        Args:</span>
<span class="sd">            time(float): timestamp.</span>
<span class="sd">        Returns:</span>
<span class="sd">            int, int: index of the closest events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lasti</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">time</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lasti</span><span class="p">,</span> <span class="n">i</span>
            <span class="n">lasti</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">lasti</span><span class="p">,</span> <span class="n">lasti</span></div>

<div class="viewcode-block" id="BatteryStatsParser.get_events_in_between"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.get_events_in_between">[docs]</a>    <span class="k">def</span> <span class="nf">get_events_in_between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get batstat events occured between start_time and end_time.</span>
<span class="sd">        Args:</span>
<span class="sd">            start_time(int): start timestamp.</span>
<span class="sd">            end_time(int): end timestamp.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: events occurred.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">metrics</span>
        <span class="n">c_beg_bef</span><span class="p">,</span> <span class="n">c_beg_aft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_closest_pair</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
        <span class="c1"># {&#39;health: [(event_state,start,end, pctage_duration)], ..}</span>
        <span class="n">prev_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">c_beg_aft</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">start_time</span>
        <span class="n">fst_time</span> <span class="o">=</span> <span class="n">prev_time</span>
        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">c_beg_aft</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">end_time</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">kup</span><span class="p">,</span> <span class="n">upval</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">updates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">metrics</span><span class="p">[</span><span class="n">kup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">kup</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">else</span> <span class="n">metrics</span><span class="p">[</span><span class="n">kup</span><span class="p">]</span>
                <span class="n">contains_update_val</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">kup</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">upval</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="n">kup</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># next(filter(lambda x: x[0] == upval, metrics[kup]), None)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">contains_update_val</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">kup</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># update previous state</span>
                        <span class="n">duration_pctage</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">((</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">metrics</span><span class="p">[</span><span class="n">kup</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
                        <span class="n">metrics</span><span class="p">[</span><span class="n">kup</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">metrics</span><span class="p">[</span><span class="n">kup</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">metrics</span><span class="p">[</span><span class="n">kup</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">duration_pctage</span><span class="p">)</span>  <span class="c1"># last_time?</span>
                    <span class="n">init_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="k">if</span> <span class="n">fst_time</span> <span class="o">==</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span> <span class="k">else</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span>
                    <span class="n">duration_pctage</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">((</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">init_time</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="n">kup</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">upval</span><span class="p">,</span> <span class="n">init_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">duration_pctage</span><span class="p">))</span>
            <span class="c1"># concs</span>
            <span class="k">for</span> <span class="n">cup</span><span class="p">,</span> <span class="n">cupval</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">concurrentUpdates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">metrics</span><span class="p">[</span><span class="n">cup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">cup</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">else</span> <span class="n">metrics</span><span class="p">[</span><span class="n">cup</span><span class="p">]</span>
                <span class="c1"># detect pushes</span>
                <span class="k">for</span> <span class="n">c_i</span><span class="p">,</span> <span class="n">cval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cupval</span><span class="p">):</span>
                    <span class="c1"># is_in_metrics = metrics[cup][-1][0][&#39;val&#39;] == cval[&#39;val&#39;] and metrics[cup][-1][0][&#39;val2&#39;] == cval[&#39;val2&#39;]  if len(metrics[cup]) &gt; 0 else False</span>
                    <span class="n">is_in_metrics</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cval</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;val2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cval</span><span class="p">[</span><span class="s1">&#39;val2&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">end_time</span><span class="p">,</span>
                        <span class="n">metrics</span><span class="p">[</span><span class="n">cup</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_in_metrics</span><span class="p">:</span>
                        <span class="c1"># new state, add</span>
                        <span class="n">init_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="k">if</span> <span class="n">prev_time</span> <span class="o">==</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span> <span class="k">else</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span>
                        <span class="n">duration_pctage</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">((</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">init_time</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
                        <span class="n">metrics</span><span class="p">[</span><span class="n">cup</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cval</span><span class="p">,</span> <span class="n">init_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">duration_pctage</span><span class="p">))</span>
                <span class="c1"># detect pops</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val_of_metrics</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">cup</span><span class="p">]):</span>
                    <span class="n">this_ev_contains_val</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">val_of_metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;val2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">val_of_metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;val2&#39;</span><span class="p">],</span>
                        <span class="n">cupval</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">this_ev_contains_val</span><span class="p">:</span>
                        <span class="c1"># was popped, update</span>
                        <span class="n">already_popped</span> <span class="o">=</span> <span class="n">val_of_metrics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">end_time</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">already_popped</span><span class="p">:</span>
                            <span class="n">prev_start_time</span> <span class="o">=</span> <span class="n">val_of_metrics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">duration_pctage</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">((</span><span class="n">ev</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">prev_start_time</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
                            <span class="n">metrics</span><span class="p">[</span><span class="n">cup</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_of_metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prev_start_time</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">duration_pctage</span><span class="p">)</span>
            <span class="n">prev_time</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">time</span>
        <span class="k">return</span> <span class="n">metrics</span></div>

<div class="viewcode-block" id="BatteryStatsParser.get_CPU_samples_in_between"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.get_CPU_samples_in_between">[docs]</a>    <span class="k">def</span> <span class="nf">get_CPU_samples_in_between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns cpu states recorded between start and end time.</span>
<span class="sd">        Args:</span>
<span class="sd">            start_time(int): start timestamp.</span>
<span class="sd">            end_time(int): end timestamp.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: states occurred.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">last_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">start_time</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">last_time</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">last_ev</span><span class="o">.</span><span class="n">currents</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span>
                <span class="n">voltage</span> <span class="o">=</span> <span class="n">last_ev</span><span class="o">.</span><span class="n">get_voltage_value</span><span class="p">()</span>  <span class="c1"># float(last_ev.updates[&quot;volt&quot;])</span>
                <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">voltage</span><span class="p">)</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
                <span class="n">last_time</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span>
            <span class="n">last_ev</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">last_delta</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">last_time</span>
        <span class="n">last_state</span> <span class="o">=</span> <span class="n">last_ev</span><span class="o">.</span><span class="n">currents</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span>
        <span class="n">last_voltage</span> <span class="o">=</span> <span class="n">last_ev</span><span class="o">.</span><span class="n">get_voltage_value</span><span class="p">()</span>  <span class="c1"># float(last_ev.updates[&quot;volt&quot;])</span>
        <span class="n">last_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_delta</span><span class="p">,</span> <span class="n">last_state</span><span class="p">,</span> <span class="n">last_voltage</span><span class="p">)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_pair</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span></div>

<div class="viewcode-block" id="BatteryStatsParser.determinate_component_current"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.determinate_component_current">[docs]</a>    <span class="k">def</span> <span class="nf">determinate_component_current</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bt_event</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">,</span> <span class="n">possible_states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;calculates current being consumed during bt_event by component identified by comp_name.</span>

<span class="sd">        Args:</span>
<span class="sd">            bt_event: event.</span>
<span class="sd">            comp_name: component name.</span>
<span class="sd">            possible_states: possible states of the component.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: current being consumed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">curravg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">avg_ct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># screen</span>
        <span class="k">if</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;screen&quot;</span> <span class="ow">and</span> <span class="s2">&quot;screen&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
            <span class="n">on_current</span> <span class="o">=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">]</span>
            <span class="n">brightness_level</span> <span class="o">=</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">[</span><span class="s2">&quot;brightness&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;brightness&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">relative_full_current</span> <span class="o">=</span> <span class="p">(</span><span class="n">brightness_level</span> <span class="o">*</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;brightness&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">current</span> <span class="o">+=</span> <span class="n">on_current</span> <span class="o">+</span> <span class="n">relative_full_current</span>

        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;ambient&quot;</span> <span class="ow">and</span> <span class="s2">&quot;screen_doze&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
            <span class="c1"># power profile might have a defined value for ambient/doze screen consumpri</span>
            <span class="n">doze_current</span> <span class="o">=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">]</span>
            <span class="n">current</span> <span class="o">+=</span> <span class="n">doze_current</span>

        <span class="c1"># camera/flashlight</span>
        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;camera&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;camera&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="c1"># usually available as avg consumption (Intended as a rough estimate for an application running a preview and capturing approximately 10 full-resolution pictures per minute.)</span>
                <span class="n">cam_current</span> <span class="o">=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;avg&quot;</span><span class="p">]</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">cam_current</span>

            <span class="k">if</span> <span class="s2">&quot;flashlight&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="n">flash_curr</span> <span class="o">=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;flashlight&quot;</span><span class="p">]</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">flash_curr</span>
        <span class="c1"># dsp</span>
        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;dsp&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;video&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="n">video_curr</span> <span class="o">=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;video&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;dsp&quot;</span> <span class="k">else</span> <span class="n">possible_states</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">video_curr</span>

            <span class="k">if</span> <span class="s2">&quot;audio&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="n">audio_curr</span> <span class="o">=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;audio&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;dsp&quot;</span> <span class="k">else</span> <span class="n">possible_states</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">audio_curr</span>

        <span class="c1"># audio</span>
        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;video&quot;</span> <span class="ow">and</span> <span class="s2">&quot;video&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
            <span class="n">video_curr</span> <span class="o">=</span> <span class="n">possible_states</span>
            <span class="n">current</span> <span class="o">+=</span> <span class="n">video_curr</span>
        <span class="c1"># video</span>
        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span> <span class="ow">and</span> <span class="s2">&quot;audio&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
            <span class="n">audio_curr</span> <span class="o">=</span> <span class="n">possible_states</span>
            <span class="n">current</span> <span class="o">+=</span> <span class="n">audio_curr</span>

        <span class="c1"># wifi</span>
        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;wifi&quot;</span> <span class="ow">and</span> <span class="s2">&quot;wifi_running&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
            <span class="n">on_current</span> <span class="o">=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;on&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">on_current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">][</span><span class="s2">&quot;idle&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span>
                        <span class="s2">&quot;controller&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span> <span class="ow">and</span> <span class="s2">&quot;idle&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">])</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">current</span> <span class="o">+=</span> <span class="n">on_current</span>
            <span class="k">if</span> <span class="s2">&quot;wifi_scan&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;scan&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">:</span>
                    <span class="n">current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;scan&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;controller&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">:</span>
                    <span class="n">curravg</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">avg_ct</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="s2">&quot;tx&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]:</span>
                        <span class="n">curravg</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">][</span><span class="s2">&quot;tx&quot;</span><span class="p">]</span>
                        <span class="n">avg_ct</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="s2">&quot;rx&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]:</span>
                        <span class="n">curravg</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">][</span><span class="s2">&quot;rx&quot;</span><span class="p">]</span>
                        <span class="n">avg_ct</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">current</span> <span class="o">+=</span> <span class="n">safe_division</span><span class="p">(</span><span class="n">curravg</span><span class="p">,</span> <span class="n">avg_ct</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;wifi_radio&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;active&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="s2">&quot;controller&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">:</span>
                    <span class="n">curravg</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">avg_ct</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="s2">&quot;tx&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]:</span>
                        <span class="n">curravg</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">][</span><span class="s2">&quot;tx&quot;</span><span class="p">]</span>
                        <span class="n">avg_ct</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="s2">&quot;rx&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]:</span>
                        <span class="n">curravg</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">][</span><span class="s2">&quot;rx&quot;</span><span class="p">]</span>
                        <span class="n">avg_ct</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">current</span> <span class="o">+=</span> <span class="n">safe_division</span><span class="p">(</span><span class="n">curravg</span><span class="p">,</span> <span class="n">avg_ct</span><span class="p">)</span>

        <span class="c1"># gps</span>
        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;gps&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;signalqualitybased&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">:</span>  <span class="c1"># and &quot;gps_signal_quality&quot; in bt_event.updates:</span>
                <span class="c1"># considerate gps signal quality</span>
                <span class="k">if</span> <span class="s2">&quot;gps_signal_quality&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">[</span><span class="s2">&quot;gps_signal_quality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;good&quot;</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;signalqualitybased&quot;</span><span class="p">][</span><span class="n">val</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;on&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span> <span class="ow">and</span> <span class="s2">&quot;gps&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">]</span>

        <span class="c1"># bluetooth</span>
        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;bluetooth&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">android_version</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="ow">or</span> <span class="s2">&quot;controller&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">:</span>
                <span class="c1"># account blue on and active vals</span>
                <span class="k">if</span> <span class="s2">&quot;ble_scan&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                    <span class="n">current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;active&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;on&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="s2">&quot;bluetooth&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                    <span class="n">current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;on&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="s2">&quot;controller&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">][</span><span class="s2">&quot;idle&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;idle&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">])</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="s2">&quot;ble_scan&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;tx&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]:</span>
                        <span class="n">curravg</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">][</span><span class="s2">&quot;tx&quot;</span><span class="p">]</span>
                        <span class="n">avg_ct</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="s2">&quot;rx&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]:</span>
                        <span class="n">curravg</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">][</span><span class="s2">&quot;rx&quot;</span><span class="p">]</span>
                        <span class="n">avg_ct</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">current</span> <span class="o">+=</span> <span class="n">safe_division</span><span class="p">(</span><span class="n">curravg</span><span class="p">,</span> <span class="n">avg_ct</span><span class="p">)</span>

        <span class="c1"># radio =  modem</span>
        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;radio&quot;</span><span class="p">:</span>
            <span class="c1"># radio.on</span>
            <span class="k">if</span> <span class="s2">&quot;phone_scanning&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="c1"># radio.scanning</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;scanning&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;scanning&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="k">elif</span> <span class="s2">&quot;mobile_radio&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="n">on_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;on&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="n">signal_stren</span> <span class="o">=</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">[</span>
                    <span class="s2">&quot;phone_signal_strength&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;phone_signal_strength&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">signal_stren</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">on_vals</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">on_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">current</span> <span class="o">+=</span> <span class="n">on_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">on_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">current</span> <span class="o">+=</span> <span class="n">on_vals</span><span class="p">[</span><span class="n">signal_stren</span><span class="p">]</span>
            <span class="c1"># radio.active == mobile_radio - transmiting</span>

        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;modem&quot;</span><span class="p">:</span>
            <span class="c1"># same as radio</span>
            <span class="k">if</span> <span class="s2">&quot;phone_scanning&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="n">curravg</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">avg_ct</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="s2">&quot;tx&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]:</span>
                    <span class="n">on_vals</span> <span class="o">=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">][</span><span class="s2">&quot;tx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;tx&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
                    <span class="n">signal_stren</span> <span class="o">=</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">[</span>
                        <span class="s2">&quot;phone_signal_strength&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;phone_signal_strength&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">signal_stren</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">on_vals</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">on_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">curravg</span> <span class="o">+=</span> <span class="n">on_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">on_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">curravg</span> <span class="o">+=</span> <span class="n">on_vals</span><span class="p">[</span><span class="n">signal_stren</span><span class="p">]</span>
                    <span class="n">avg_ct</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="s2">&quot;rx&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]:</span>
                    <span class="n">curravg</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">][</span><span class="s2">&quot;rx&quot;</span><span class="p">]</span>
                    <span class="n">avg_ct</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">safe_division</span><span class="p">(</span><span class="n">curravg</span><span class="p">,</span> <span class="n">avg_ct</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;mobile_radio&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">possible_states</span><span class="p">[</span><span class="s2">&quot;idle&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;idle&quot;</span> <span class="ow">in</span> <span class="n">possible_states</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="c1"># cpu</span>
        <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
            <span class="c1"># retrieve just the component state</span>
            <span class="c1"># if phone has multiple cpu_clusters and that info is present in power profile file</span>
            <span class="c1"># only for devices with heterogeneous CPU architectures.</span>
            <span class="c1"># print(possible_states)</span>
            <span class="c1"># has_multiple_cpu_clusters= &quot;clusters&quot; in possible_states and &quot;cores&quot; in possible_states[&quot;clusters&quot;] and  len(possible_states[&quot;clusters&quot;][&quot;cores&quot;])&gt;1</span>
            <span class="c1"># if has_multiple_cpu_clusters:</span>
            <span class="c1"># cores_per_cluster = possible_states[&quot;clusters&quot;][&quot;cores&quot;]</span>
            <span class="c1"># calculate energy per cluster</span>
            <span class="c1"># if areInMinCPUFreq(bt_event.updates[&quot;cpufreq&quot;] , possible_states):</span>
            <span class="c1"># assume is just awake</span>

            <span class="c1">#		current += possible_states[&quot;awake&quot;]</span>
            <span class="c1">#		else:</span>

            <span class="c1"># calculate active state</span>
            <span class="c1">#			current += 0 # possible_states[&quot;awake&quot;] if &quot;awake&quot; in possible_states else 0</span>
            <span class="c1">#			print(&quot;TODO Calculate power according to freq&quot;)</span>

            <span class="c1">#	else:</span>
            <span class="k">if</span> <span class="s2">&quot;running&quot;</span> <span class="ow">in</span> <span class="n">bt_event</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
                <span class="c1"># is active or just awake</span>
                <span class="c1"># if &quot;awake&quot; in possible_states and areInMinCPUFreq(bt_event.updates[&quot;cpufreq&quot;] , possible_states):</span>
                <span class="c1"># if areInMinCPUFreq(bt_event.updates[&quot;cpufreq&quot;] , possible_states):</span>
                <span class="c1"># assume is just awake</span>

                <span class="c1">#	current += possible_states[&quot;awake&quot;]</span>
                <span class="c1"># else:</span>
                <span class="c1"># calculate active state</span>
                <span class="c1">#	current += 0 # possible_states[&quot;awake&quot;] if &quot;awake&quot; in possible_states else 0</span>
                <span class="c1">#	print(&quot;TODO Calculate power according to freq&quot;)</span>
                <span class="n">current</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># cpu in idle state</span>
                <span class="c1"># current+= possible_states[&quot;idle&quot;] if &quot;idle&quot; in possible_states else 0</span>
                <span class="n">current</span> <span class="o">=</span> <span class="s2">&quot;idle&quot;</span>

        <span class="k">return</span> <span class="n">current</span></div>

<div class="viewcode-block" id="BatteryStatsParser.parse_file"><a class="viewcode-back" href="../../../../manafa.parsing.batteryStats.html#manafa.parsing.batteryStats.BatteryStatsParser.BatteryStatsParser.parse_file">[docs]</a>    <span class="k">def</span> <span class="nf">parse_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;parses events ands stores event from file with output from dumpsys batterystats command.</span>
<span class="sd">        Args:</span>
<span class="sd">            filepath: output filepath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_history</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div></div>

<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<span class="c1"># if len(sys.argv)&gt;1:</span>
<span class="c1"># pp = &quot;samples/profiles/power_profile.xml&quot;</span>
<span class="c1"># pp = &quot;samples/profiles/power_profile_pixel3a_grapheneos.xml&quot;</span>
<span class="c1"># x = BatteryStatsParser(powerProfile=pp,timezone=&quot;WET&quot;)</span>
<span class="c1"># x.parseFile(sys.argv[1])</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Rui Rua.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>